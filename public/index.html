<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Essaim â€” Reddit Marketing IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#fff7ed',
              100: '#ffedd5',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { background: #f9fafb; }
    .sidebar { background: #fff; border-right: 1px solid #e5e7eb; }
    .card { background: #fff; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .card:hover { border-color: #d1d5db; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .topbar { background: #fff; border-bottom: 1px solid #e5e7eb; }
    .tag-pending { background: #fef3c7; color: #92400e; }
    .tag-generated { background: #dbeafe; color: #1e40af; }
    .tag-approved { background: #d1fae5; color: #065f46; }
    .tag-dismissed { background: #f3f4f6; color: #6b7280; }
    .nav-active { background: #fff7ed; color: #ea580c; font-weight: 600; }
    .campaign-active { background: #fff7ed; border-left: 3px solid #f97316; }
    .campaign-item { border-left: 3px solid transparent; transition: all 0.15s; }
    .campaign-item:hover { background: #f9fafb; }
    .tab-active { color: #ea580c; border-bottom: 2px solid #f97316; }
    .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
    .tab-inactive:hover { color: #374151; }
    input, textarea, select { background: #fff; border: 1px solid #d1d5db; color: #111827; border-radius: 8px; transition: border 0.15s; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249,115,22,0.1); }
    input::placeholder, textarea::placeholder { color: #9ca3af; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.25s ease forwards; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { display:inline-block; animation: spin 0.7s linear infinite; }
    .modal-bg { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
    .score-track { background: #e5e7eb; }
    .btn-primary { background: #f97316; color: white; font-weight: 600; transition: background 0.15s; }
    .btn-primary:hover { background: #ea580c; }
    .btn-primary:disabled { background: #fed7aa; cursor: not-allowed; }
    .btn-ghost { background: transparent; color: #374151; border: 1px solid #d1d5db; transition: all 0.15s; }
    .btn-ghost:hover { background: #f9fafb; border-color: #9ca3af; }
    .stat-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px 24px; }
    .reply-card { border: 1px solid #e5e7eb; border-radius: 12px; transition: border 0.15s; }
    .reply-card:hover { border-color: #f97316; }
  </style>
</head>
<body class="min-h-screen text-gray-800 font-sans flex">

<!-- â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar w-60 min-h-screen flex flex-col flex-shrink-0">

  <!-- Logo -->
  <div class="px-5 py-5 border-b border-gray-100">
    <div class="flex items-center gap-2.5">
      <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white font-bold text-sm">ğŸ</div>
      <div>
        <div class="font-bold text-gray-900 text-base leading-tight">Essaim</div>
        <div class="text-xs text-gray-400">Reddit Marketing IA</div>
      </div>
    </div>
  </div>

  <!-- New campaign -->
  <div class="px-3 pt-4 pb-2">
    <button onclick="openNewCampaignModal()"
      class="btn-primary w-full py-2 px-4 rounded-lg text-sm flex items-center justify-center gap-1.5">
      <span class="text-lg leading-none">+</span> Nouvelle campagne
    </button>
  </div>

  <!-- Campaigns -->
  <div class="flex-1 overflow-y-auto px-2 py-2">
    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 py-2">Campagnes</div>
    <div id="campaigns-list" class="space-y-0.5"></div>
  </div>

  <!-- Scan -->
  <div class="p-3 border-t border-gray-100">
    <button onclick="triggerScan()" id="scan-btn"
      class="btn-ghost w-full py-2 px-3 rounded-lg text-sm flex items-center justify-center gap-2">
      <span id="scan-icon">ğŸ”</span> Scanner Reddit
    </button>
    <div id="scan-status" class="text-xs text-gray-500 text-center mt-1.5 hidden"></div>
  </div>
</aside>

<!-- â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="flex-1 flex flex-col min-h-screen overflow-hidden">

  <!-- Top bar -->
  <header class="topbar px-6 py-4 flex items-center justify-between flex-shrink-0">
    <div>
      <h1 id="page-title" class="font-semibold text-gray-900 text-base">Toutes les opportunitÃ©s</h1>
      <p id="page-subtitle" class="text-sm text-gray-400 mt-0.5">Threads Reddit pertinents pour vos campagnes</p>
    </div>
    <div class="flex items-center gap-6">
      <div class="text-center">
        <div id="stat-pending" class="font-bold text-brand-500 text-xl leading-tight">â€“</div>
        <div class="text-xs text-gray-400">En attente</div>
      </div>
      <div class="w-px h-8 bg-gray-200"></div>
      <div class="text-center">
        <div id="stat-approved" class="font-bold text-green-500 text-xl leading-tight">â€“</div>
        <div class="text-xs text-gray-400">ApprouvÃ©es</div>
      </div>
      <div class="w-px h-8 bg-gray-200"></div>
      <div class="text-center">
        <div id="stat-campaigns" class="font-bold text-gray-700 text-xl leading-tight">â€“</div>
        <div class="text-xs text-gray-400">Campagnes</div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="bg-white border-b border-gray-200 px-6 flex gap-0 flex-shrink-0">
    <button onclick="setTab('pending')" id="tab-pending"
      class="tab tab-active px-4 py-3 text-sm font-medium transition-colors">
      En attente
    </button>
    <button onclick="setTab('generated')" id="tab-generated"
      class="tab tab-inactive px-4 py-3 text-sm font-medium transition-colors">
      GÃ©nÃ©rÃ©es
    </button>
    <button onclick="setTab('approved')" id="tab-approved"
      class="tab tab-inactive px-4 py-3 text-sm font-medium transition-colors">
      ApprouvÃ©es âœ“
    </button>
    <button onclick="setTab('dismissed')" id="tab-dismissed"
      class="tab tab-inactive px-4 py-3 text-sm font-medium transition-colors">
      IgnorÃ©es
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">

    <!-- Empty state -->
    <div id="empty-state" class="text-center py-24">
      <div class="w-16 h-16 bg-brand-50 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">ğŸ</div>
      <h3 class="font-semibold text-gray-700 text-lg mb-2">Aucune opportunitÃ© pour l'instant</h3>
      <p class="text-gray-400 text-sm max-w-sm mx-auto">CrÃ©ez une campagne et lancez un scan pour dÃ©couvrir des threads Reddit oÃ¹ mentionner votre produit naturellement.</p>
      <button onclick="openNewCampaignModal()"
        class="btn-primary mt-5 px-5 py-2.5 rounded-lg text-sm inline-flex items-center gap-2">
        CrÃ©er ma premiÃ¨re campagne â†’
      </button>
    </div>

    <!-- Grid -->
    <div id="opps-grid" class="space-y-3 max-w-3xl"></div>
  </div>
</main>

<!-- â•â•â• MODAL: NOUVELLE CAMPAGNE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-campaign" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md">
    <div class="flex items-center justify-between mb-5">
      <div>
        <h2 class="font-bold text-gray-900 text-lg">Nouvelle campagne</h2>
        <p class="text-sm text-gray-400 mt-0.5">Reddit surveillera vos subreddits en continu</p>
      </div>
      <button onclick="closeModal('modal-campaign')" class="text-gray-400 hover:text-gray-600 text-xl leading-none w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">Ã—</button>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">Nom du produit / marque</label>
        <input id="c-brand" type="text" placeholder="ex: Essaim" class="w-full px-3 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">Ce que vous proposez</label>
        <input id="c-desc" type="text" placeholder="ex: Outil de community marketing IA pour le marchÃ© FR"
          class="w-full px-3 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">
          Mots-clÃ©s Ã  surveiller
          <span class="text-gray-400 font-normal ml-1">(sÃ©parÃ©s par virgules)</span>
        </label>
        <input id="c-keywords" type="text" placeholder="ex: community marketing, reddit marketing, spam reddit"
          class="w-full px-3 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1.5">
          Subreddits Ã  surveiller
          <span class="text-gray-400 font-normal ml-1">(sans r/, virgules)</span>
        </label>
        <input id="c-subs" type="text" placeholder="ex: EntreprendreenFrance, france, SaaS_fr"
          class="w-full px-3 py-2.5 text-sm" />
        <p class="text-xs text-gray-400 mt-1.5">RecommandÃ©s : EntreprendreenFrance, france, webmarketing, SaaS_fr, AskFrance</p>
      </div>
    </div>

    <div class="flex gap-3 mt-6">
      <button onclick="closeModal('modal-campaign')" class="btn-ghost flex-1 py-2.5 rounded-lg text-sm">Annuler</button>
      <button onclick="createCampaign()" class="btn-primary flex-1 py-2.5 rounded-lg text-sm">
        CrÃ©er et scanner â†’
      </button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL: RÃ‰PONSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-responses" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[88vh] flex flex-col">

    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-100 flex items-start justify-between flex-shrink-0">
      <div class="flex-1 min-w-0 pr-4">
        <h2 class="font-bold text-gray-900">RÃ©ponses suggÃ©rÃ©es</h2>
        <p id="modal-opp-title" class="text-xs text-gray-400 mt-0.5 truncate"></p>
      </div>
      <button onclick="closeModal('modal-responses')" class="text-gray-400 hover:text-gray-600 text-xl leading-none w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 flex-shrink-0">Ã—</button>
    </div>

    <!-- Body -->
    <div class="flex-1 overflow-y-auto p-5">
      <div id="modal-loading" class="text-center py-10">
        <div class="w-10 h-10 bg-brand-50 rounded-xl flex items-center justify-center text-xl mx-auto mb-3 spin">ğŸ</div>
        <p class="text-sm text-gray-400">GÃ©nÃ©ration des rÃ©ponses...</p>
      </div>
      <div id="modal-replies" class="space-y-3 hidden"></div>
    </div>

    <!-- Footer -->
    <div id="modal-footer" class="hidden px-5 py-3 border-t border-gray-100 flex-shrink-0">
      <a id="reddit-link" href="#" target="_blank"
        class="text-sm text-orange-500 hover:text-orange-600 font-medium flex items-center gap-1.5 transition-colors">
        <span>â†—</span> Ouvrir le thread sur Reddit
      </a>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCampaignId = null;
let currentTab = 'pending';
let campaigns = [];

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await Promise.all([loadCampaigns(), loadStats()]);
  await loadOpportunities();
}

// â”€â”€â”€ Campaigns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCampaigns() {
  try {
    const res = await fetch('/api/campaigns');
    campaigns = await res.json();
    renderCampaigns();
  } catch(e) { console.error(e); }
}

function renderCampaigns() {
  const el = document.getElementById('campaigns-list');
  if (!campaigns.length) {
    el.innerHTML = '<p class="text-xs text-gray-400 px-3 py-2">Aucune campagne</p>';
    return;
  }
  el.innerHTML = campaigns.map(c => `
    <div onclick="selectCampaign(${c.id})" id="campaign-${c.id}"
      class="campaign-item cursor-pointer px-3 py-2.5 rounded-lg ${currentCampaignId === c.id ? 'campaign-active' : ''}">
      <div class="font-medium text-sm text-gray-800 truncate">${esc(c.brand_name)}</div>
      <div class="flex items-center gap-1.5 mt-0.5">
        ${c.pending_opportunities > 0 ? `<span class="tag-pending text-xs px-1.5 py-0.5 rounded font-medium">${c.pending_opportunities} nouveau${c.pending_opportunities > 1 ? 'x' : ''}</span>` : ''}
        <span class="text-xs text-gray-400">${c.total_opportunities} total</span>
      </div>
    </div>
  `).join('');
}

function selectCampaign(id) {
  currentCampaignId = currentCampaignId === id ? null : id;
  const campaign = campaigns.find(c => c.id === id);
  document.getElementById('page-title').textContent = currentCampaignId && campaign ? campaign.brand_name : 'Toutes les opportunitÃ©s';
  document.getElementById('page-subtitle').textContent = currentCampaignId && campaign ? campaign.description : 'Threads Reddit pertinents pour vos campagnes';
  renderCampaigns();
  loadOpportunities();
}

// â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const s = await fetch('/api/stats').then(r => r.json());
    document.getElementById('stat-pending').textContent = s.pending_opportunities;
    document.getElementById('stat-approved').textContent = s.approved;
    document.getElementById('stat-campaigns').textContent = s.active_campaigns;
  } catch(e) {}
}

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => {
    t.classList.remove('tab-active'); t.classList.add('tab-inactive');
  });
  const el = document.getElementById(`tab-${tab}`);
  el.classList.remove('tab-inactive'); el.classList.add('tab-active');
  loadOpportunities();
}

// â”€â”€â”€ Opportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOpportunities() {
  try {
    let url = `/api/opportunities?status=${currentTab}&limit=50`;
    if (currentCampaignId) url += `&campaign_id=${currentCampaignId}`;
    const opps = await fetch(url).then(r => r.json());
    renderOpps(opps);
  } catch(e) { console.error(e); }
}

function renderOpps(opps) {
  const grid = document.getElementById('opps-grid');
  const empty = document.getElementById('empty-state');
  if (!opps.length) {
    grid.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  grid.innerHTML = opps.map((o, i) => {
    const sc = o.relevance_score;
    const scoreColor = sc >= 7 ? 'bg-green-500' : sc >= 4 ? 'bg-orange-400' : 'bg-gray-300';
    const scoreText = sc >= 7 ? 'text-green-600' : sc >= 4 ? 'text-orange-500' : 'text-gray-400';
    const tag = { pending:'tag-pending', generated:'tag-generated', approved:'tag-approved', dismissed:'tag-dismissed' }[o.status];
    const tagLabel = { pending:'En attente', generated:'GÃ©nÃ©rÃ©e', approved:'ApprouvÃ©e âœ“', dismissed:'IgnorÃ©e' }[o.status];
    const time = fmtTime(o.detected_at);
    return `
    <div class="card rounded-xl p-4 fade-in" style="animation-delay:${i*0.04}s">
      <div class="flex items-start gap-3">
        <div class="flex-1 min-w-0">
          <div class="flex flex-wrap items-center gap-2 mb-1.5">
            <span class="text-xs font-semibold text-orange-500 bg-orange-50 px-2 py-0.5 rounded">r/${esc(o.subreddit)}</span>
            <span class="${tag} text-xs px-2 py-0.5 rounded font-medium">${tagLabel}</span>
            <span class="text-xs text-gray-400">${time}</span>
          </div>
          <h3 class="font-medium text-gray-900 text-sm leading-snug mb-1">${esc(o.title)}</h3>
          ${o.body ? `<p class="text-xs text-gray-400 line-clamp-2">${esc(o.body.slice(0,160))}</p>` : ''}
        </div>
        <div class="flex-shrink-0 text-center w-10">
          <div class="${scoreText} font-bold text-sm">${sc}/10</div>
          <div class="w-8 h-1.5 score-track rounded-full mt-1 mx-auto overflow-hidden">
            <div class="${scoreColor} h-full rounded-full" style="width:${sc*10}%"></div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-100">
        <button onclick="openResponseModal(${o.id}, ${JSON.stringify(o.title)}, '${esc(o.url)}')"
          class="btn-primary flex-1 text-xs py-2 px-3 rounded-lg">
          ${o.status === 'pending' ? 'ğŸ GÃ©nÃ©rer une rÃ©ponse' : 'âœï¸ Voir les rÃ©ponses'}
        </button>
        <a href="${esc(o.url)}" target="_blank"
          class="btn-ghost text-xs py-2 px-3 rounded-lg">
          Reddit â†—
        </a>
        ${o.status !== 'approved' ? `
        <button onclick="updateOpp(${o.id},'approved')" title="Approuver"
          class="btn-ghost text-green-600 text-xs py-2 px-3 rounded-lg">âœ“</button>` : ''}
        <button onclick="updateOpp(${o.id},'dismissed')" title="Ignorer"
          class="btn-ghost text-gray-400 text-xs py-2 px-3 rounded-lg">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ Response Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openResponseModal(oppId, title, url) {
  document.getElementById('modal-opp-title').textContent = title;
  document.getElementById('modal-loading').classList.remove('hidden');
  document.getElementById('modal-replies').classList.add('hidden');
  document.getElementById('modal-replies').innerHTML = '';
  document.getElementById('modal-footer').classList.add('hidden');
  document.getElementById('reddit-link').href = url;
  document.getElementById('modal-responses').classList.remove('hidden');

  try {
    const data = await fetch(`/api/opportunities/${oppId}/generate`, { method: 'POST' }).then(r => r.json());
    if (data.error) throw new Error(data.error);

    document.getElementById('modal-loading').classList.add('hidden');
    document.getElementById('modal-footer').classList.remove('hidden');

    const repliesEl = document.getElementById('modal-replies');
    repliesEl.classList.remove('hidden');

    const styleIcon = { Casual: 'ğŸ˜Š', Expert: 'ğŸ“', Humour: 'ğŸ˜„' };
    const styleColor = { Casual: 'bg-blue-50 text-blue-700', Expert: 'bg-purple-50 text-purple-700', Humour: 'bg-green-50 text-green-700' };
    const scoreBg = (s) => s >= 8 ? 'bg-green-500' : s >= 6 ? 'bg-orange-400' : 'bg-red-400';

    repliesEl.innerHTML = data.replies.map((r, i) => `
      <div class="reply-card bg-white p-4 fade-in" style="animation-delay:${i*0.08}s">
        <div class="flex items-center justify-between mb-3">
          <span class="text-xs font-semibold px-2 py-1 rounded-lg ${styleColor[r.style] || 'bg-gray-100 text-gray-600'}">
            ${styleIcon[r.style] || ''} ${r.style}
          </span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Score anti-ban</span>
            <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
              <div class="${scoreBg(r.score)} h-full rounded-full" style="width:${r.score*10}%"></div>
            </div>
            <span class="text-xs font-semibold text-gray-600">${r.score}/10</span>
          </div>
        </div>
        <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap mb-3 bg-gray-50 rounded-lg p-3">${esc(r.text)}</p>
        ${r.tips?.length ? `<p class="text-xs text-gray-400 mb-3">ğŸ’¡ ${r.tips.join(' Â· ')}</p>` : ''}
        <button onclick="copyReply(this, ${JSON.stringify(r.text)})"
          class="btn-ghost w-full text-xs py-2 rounded-lg font-medium">
          ğŸ“‹ Copier
        </button>
      </div>
    `).join('');

    await updateOpp(oppId, 'generated', false);
    await loadOpportunities(); await loadStats();
  } catch(err) {
    document.getElementById('modal-loading').innerHTML =
      `<div class="text-red-500 text-sm text-center py-4">âŒ ${err.message}</div>`;
  }
}

function copyReply(btn, text) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = 'âœ… CopiÃ© dans le presse-papier';
    btn.style.background = '#d1fae5'; btn.style.borderColor = '#6ee7b7'; btn.style.color = '#065f46';
    setTimeout(() => { btn.innerHTML = orig; btn.style = ''; }, 2500);
  });
}

// â”€â”€â”€ Create Campaign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewCampaignModal() {
  document.getElementById('modal-campaign').classList.remove('hidden');
}

async function createCampaign() {
  const brand = document.getElementById('c-brand').value.trim();
  const desc = document.getElementById('c-desc').value.trim();
  const keywords = document.getElementById('c-keywords').value.trim();
  const subs = document.getElementById('c-subs').value.trim();
  if (!brand || !desc || !keywords || !subs) { alert('Tous les champs sont requis.'); return; }

  try {
    const campaign = await fetch('/api/campaigns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ brand_name: brand, description: desc, keywords, subreddits: subs })
    }).then(r => r.json());

    closeModal('modal-campaign');
    ['c-brand','c-desc','c-keywords','c-subs'].forEach(id => document.getElementById(id).value = '');
    await loadCampaigns(); await loadStats();
    selectCampaign(campaign.id);
    setTimeout(async () => { await loadOpportunities(); await loadStats(); await loadCampaigns(); }, 8000);
  } catch(err) { alert('Erreur : ' + err.message); }
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateOpp(id, status, reload = true) {
  await fetch(`/api/opportunities/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  });
  if (reload) { await loadOpportunities(); await loadStats(); await loadCampaigns(); }
}

async function triggerScan() {
  const btn = document.getElementById('scan-btn');
  const icon = document.getElementById('scan-icon');
  const status = document.getElementById('scan-status');
  btn.disabled = true;
  icon.className = 'spin'; icon.textContent = 'âŸ³';
  status.textContent = 'Scan en cours...'; status.classList.remove('hidden');
  try {
    const res = await fetch('/api/scan', { method: 'POST' }).then(r => r.json());
    status.textContent = res.found > 0 ? `âœ“ ${res.found} nouvelle${res.found > 1 ? 's' : ''} opportunitÃ©${res.found > 1 ? 's' : ''}` : 'Aucune nouvelle opportunitÃ©';
    await loadOpportunities(); await loadStats(); await loadCampaigns();
  } catch(e) { status.textContent = 'âœ• Erreur lors du scan'; }
  finally {
    btn.disabled = false; icon.className = ''; icon.textContent = 'ğŸ”';
    setTimeout(() => status.classList.add('hidden'), 5000);
  }
}

function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmtTime(d) {
  const diff = (Date.now() - new Date(d+'Z').getTime()) / 1000;
  if (diff < 60) return 'Ã€ l\'instant';
  if (diff < 3600) return `il y a ${Math.floor(diff/60)} min`;
  if (diff < 86400) return `il y a ${Math.floor(diff/3600)} h`;
  return `il y a ${Math.floor(diff/86400)} j`;
}

['modal-campaign','modal-responses'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal(id);
  });
});

setInterval(() => { loadStats(); loadCampaigns(); loadOpportunities(); }, 120000);
init();
</script>
</body>
</html>
