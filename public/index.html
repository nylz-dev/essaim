<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Essaim â€” Community Marketing IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            honey: { 300: '#FCD34D', 400: '#FBBF24', 500: '#F59E0B', 600: '#D97706' }
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0a0908; font-family: system-ui, -apple-system, sans-serif; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #1c1917; } ::-webkit-scrollbar-thumb { background: #44403c; border-radius: 3px; }
    .sidebar { background: #111110; border-right: 1px solid #292524; }
    .card { background: #1c1917; border: 1px solid #292524; }
    .card:hover { border-color: #44403c; }
    .badge-pending { background: #451a03; color: #fb923c; border: 1px solid #7c2d12; }
    .badge-generated { background: #1e3a5f; color: #60a5fa; border: 1px solid #1d4ed8; }
    .badge-approved { background: #14532d; color: #4ade80; border: 1px solid #166534; }
    .badge-dismissed { background: #1c1917; color: #78716c; border: 1px solid #44403c; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 0.7s linear infinite; }
    .modal-bg { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    .score-fill { transition: width 0.5s ease; }
    .tab-active { background: #292524; color: #fbbf24; }
    .campaign-item.active { background: #1c1917; border-left: 3px solid #f59e0b; }
    .campaign-item { border-left: 3px solid transparent; }
    input, textarea, select { background: #111110; border: 1px solid #292524; color: #e7e5e4; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #f59e0b; }
    input::placeholder, textarea::placeholder { color: #57534e; }
  </style>
</head>
<body class="text-stone-200 min-h-screen flex">

<!-- â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar w-64 min-h-screen flex flex-col flex-shrink-0">
  <div class="p-5 border-b border-stone-800">
    <div class="flex items-center gap-2.5">
      <span class="text-2xl">ğŸ</span>
      <div>
        <div class="font-bold text-honey-400 text-base leading-tight">Essaim</div>
        <div class="text-xs text-stone-600">Community Marketing IA</div>
      </div>
    </div>
  </div>

  <div class="p-3 border-b border-stone-800">
    <button onclick="openNewCampaignModal()"
      class="w-full bg-honey-500 hover:bg-honey-600 text-stone-900 font-semibold py-2 px-3 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
      <span>+</span> Nouvelle campagne
    </button>
  </div>

  <div class="flex-1 overflow-y-auto p-2">
    <div class="text-xs text-stone-600 px-2 py-1.5 uppercase tracking-wider">Campagnes</div>
    <div id="campaigns-list" class="space-y-0.5"></div>
  </div>

  <div class="p-3 border-t border-stone-800">
    <button onclick="triggerScan()"
      id="scan-btn"
      class="w-full text-stone-400 hover:text-stone-200 hover:bg-stone-800 py-2 px-3 rounded-lg text-sm transition-colors flex items-center justify-center gap-2">
      <span id="scan-icon">ğŸ”</span> Scanner maintenant
    </button>
    <div id="scan-status" class="text-xs text-stone-600 text-center mt-1 hidden"></div>
  </div>
</aside>

<!-- â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="flex-1 flex flex-col min-h-screen overflow-hidden">

  <!-- Top bar -->
  <header class="border-b border-stone-800 px-6 py-4 flex items-center justify-between flex-shrink-0" style="background:#0a0908">
    <div>
      <h1 id="page-title" class="font-semibold text-stone-200">Toutes les opportunitÃ©s</h1>
      <p id="page-subtitle" class="text-xs text-stone-500 mt-0.5">Threads Reddit oÃ¹ mentionner vos produits naturellement</p>
    </div>
    <div id="stats-bar" class="flex items-center gap-4 text-sm">
      <div class="text-center">
        <div id="stat-pending" class="font-bold text-honey-400 text-lg leading-tight">â€“</div>
        <div class="text-xs text-stone-600">En attente</div>
      </div>
      <div class="w-px h-8 bg-stone-800"></div>
      <div class="text-center">
        <div id="stat-approved" class="font-bold text-green-400 text-lg leading-tight">â€“</div>
        <div class="text-xs text-stone-600">ApprouvÃ©es</div>
      </div>
      <div class="w-px h-8 bg-stone-800"></div>
      <div class="text-center">
        <div id="stat-campaigns" class="font-bold text-stone-200 text-lg leading-tight">â€“</div>
        <div class="text-xs text-stone-600">Campagnes</div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <div class="border-b border-stone-800 px-6 flex gap-1 flex-shrink-0" style="background:#0a0908">
    <button onclick="setTab('pending')" id="tab-pending"
      class="tab px-4 py-2.5 text-sm font-medium rounded-t-lg transition-colors text-stone-400 hover:text-stone-200 tab-active">
      En attente
    </button>
    <button onclick="setTab('generated')" id="tab-generated"
      class="tab px-4 py-2.5 text-sm font-medium rounded-t-lg transition-colors text-stone-400 hover:text-stone-200">
      GÃ©nÃ©rÃ©es
    </button>
    <button onclick="setTab('approved')" id="tab-approved"
      class="tab px-4 py-2.5 text-sm font-medium rounded-t-lg transition-colors text-stone-400 hover:text-stone-200">
      ApprouvÃ©es âœ“
    </button>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto p-6">
    <div id="opportunities-container">
      <div id="empty-state" class="text-center py-20 text-stone-600">
        <div class="text-5xl mb-4">ğŸ</div>
        <div class="text-lg font-medium text-stone-500">Aucune opportunitÃ© pour l'instant</div>
        <div class="text-sm mt-2">CrÃ©ez une campagne et lancez un scan pour dÃ©tecter des threads pertinents</div>
      </div>
      <div id="opps-grid" class="space-y-3"></div>
    </div>
  </div>
</main>

<!-- â•â•â• MODAL: NOUVELLE CAMPAGNE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-campaign" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
  <div class="card rounded-2xl p-6 w-full max-w-lg">
    <div class="flex items-center justify-between mb-5">
      <h2 class="font-bold text-stone-100 text-lg">Nouvelle campagne</h2>
      <button onclick="closeModal('modal-campaign')" class="text-stone-500 hover:text-stone-300 text-2xl leading-none">Ã—</button>
    </div>

    <div class="space-y-4">
      <div>
        <label class="block text-sm text-stone-400 mb-1.5">Nom de la marque / produit</label>
        <input id="c-brand" type="text" placeholder="ex: Essaim" class="w-full rounded-lg px-4 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm text-stone-400 mb-1.5">Description courte</label>
        <input id="c-desc" type="text" placeholder="ex: Outil de community marketing IA pour le marchÃ© FR"
          class="w-full rounded-lg px-4 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm text-stone-400 mb-1.5">
          Mots-clÃ©s Ã  surveiller
          <span class="text-stone-600">(sÃ©parÃ©s par virgules)</span>
        </label>
        <input id="c-keywords" type="text" placeholder="ex: community marketing, reddit marketing, forum spam"
          class="w-full rounded-lg px-4 py-2.5 text-sm" />
      </div>
      <div>
        <label class="block text-sm text-stone-400 mb-1.5">
          Subreddits FR Ã  surveiller
          <span class="text-stone-600">(sans r/, sÃ©parÃ©s par virgules)</span>
        </label>
        <input id="c-subs" type="text" placeholder="ex: EntreprendreenFrance, france, SaaS_fr, webmarketing"
          class="w-full rounded-lg px-4 py-2.5 text-sm" />
        <p class="text-xs text-stone-600 mt-1">Suggestions : EntreprendreenFrance, france, webmarketing, SaaS_fr, AskFrance</p>
      </div>
    </div>

    <div class="flex gap-3 mt-6">
      <button onclick="closeModal('modal-campaign')"
        class="flex-1 bg-stone-800 hover:bg-stone-700 text-stone-300 font-medium py-2.5 rounded-lg text-sm transition-colors">
        Annuler
      </button>
      <button onclick="createCampaign()"
        class="flex-1 bg-honey-500 hover:bg-honey-600 text-stone-900 font-bold py-2.5 rounded-lg text-sm transition-colors">
        CrÃ©er et scanner
      </button>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL: RÃ‰PONSES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-responses" class="fixed inset-0 modal-bg z-50 hidden flex items-center justify-center p-4">
  <div class="card rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 card px-6 py-4 border-b border-stone-800 flex items-center justify-between">
      <div>
        <h2 class="font-bold text-stone-100">RÃ©ponses gÃ©nÃ©rÃ©es</h2>
        <p id="modal-opp-title" class="text-xs text-stone-500 mt-0.5 truncate max-w-md"></p>
      </div>
      <button onclick="closeModal('modal-responses')" class="text-stone-500 hover:text-stone-300 text-2xl leading-none ml-4">Ã—</button>
    </div>

    <div class="p-6">
      <div id="modal-loading" class="text-center py-10 text-stone-500">
        <div class="text-3xl mb-3">ğŸ</div>
        <div class="text-sm">GÃ©nÃ©ration en cours...</div>
      </div>
      <div id="modal-replies" class="space-y-4 hidden"></div>
      <div id="modal-reddit-link" class="mt-4 hidden">
        <a id="reddit-link" href="#" target="_blank"
          class="flex items-center gap-2 text-sm text-orange-400 hover:text-orange-300 transition-colors">
          <span>ğŸ”—</span> Ouvrir le thread Reddit â†’
        </a>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCampaignId = null;
let currentTab = 'pending';
let campaigns = [];

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadCampaigns();
  await loadStats();
  await loadOpportunities();
}

// â”€â”€â”€ Campaigns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCampaigns() {
  try {
    const res = await fetch('/api/campaigns');
    campaigns = await res.json();
    renderCampaigns();
  } catch (e) { console.error(e); }
}

function renderCampaigns() {
  const el = document.getElementById('campaigns-list');
  if (campaigns.length === 0) {
    el.innerHTML = '<p class="text-xs text-stone-600 px-2 py-2">Aucune campagne</p>';
    return;
  }

  el.innerHTML = campaigns.map(c => `
    <div onclick="selectCampaign(${c.id})"
      id="campaign-${c.id}"
      class="campaign-item cursor-pointer px-3 py-2.5 rounded-lg transition-colors hover:bg-stone-800 ${currentCampaignId === c.id ? 'active' : ''}">
      <div class="font-medium text-sm text-stone-200 truncate">${esc(c.brand_name)}</div>
      <div class="flex items-center gap-2 mt-1">
        ${c.pending_opportunities > 0 ? `<span class="badge-pending text-xs px-1.5 py-0.5 rounded">${c.pending_opportunities} nouvelles</span>` : ''}
        <span class="text-xs text-stone-600">${c.total_opportunities} total</span>
      </div>
    </div>
  `).join('');
}

function selectCampaign(id) {
  currentCampaignId = currentCampaignId === id ? null : id;
  renderCampaigns();
  loadOpportunities();
  const campaign = campaigns.find(c => c.id === id);
  if (campaign) {
    document.getElementById('page-title').textContent = campaign.brand_name;
    document.getElementById('page-subtitle').textContent = campaign.description;
  } else {
    document.getElementById('page-title').textContent = 'Toutes les opportunitÃ©s';
    document.getElementById('page-subtitle').textContent = 'Threads Reddit oÃ¹ mentionner vos produits naturellement';
  }
}

// â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    const stats = await fetch('/api/stats').then(r => r.json());
    document.getElementById('stat-pending').textContent = stats.pending_opportunities;
    document.getElementById('stat-approved').textContent = stats.approved;
    document.getElementById('stat-campaigns').textContent = stats.active_campaigns;
  } catch (e) {}
}

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
  document.getElementById(`tab-${tab}`).classList.add('tab-active');
  loadOpportunities();
}

// â”€â”€â”€ Opportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOpportunities() {
  try {
    let url = `/api/opportunities?status=${currentTab}&limit=50`;
    if (currentCampaignId) url += `&campaign_id=${currentCampaignId}`;
    const opps = await fetch(url).then(r => r.json());
    renderOpportunities(opps);
  } catch (e) { console.error(e); }
}

const styleColors = { Casual: 'text-blue-400', Expert: 'text-purple-400', Humour: 'text-green-400' };

function renderOpportunities(opps) {
  const grid = document.getElementById('opps-grid');
  const empty = document.getElementById('empty-state');

  if (opps.length === 0) {
    grid.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  grid.innerHTML = opps.map((opp, i) => {
    const scoreColor = opp.relevance_score >= 7 ? 'text-green-400' : opp.relevance_score >= 4 ? 'text-honey-400' : 'text-stone-500';
    const scoreBar = opp.relevance_score >= 7 ? 'bg-green-500' : opp.relevance_score >= 4 ? 'bg-honey-500' : 'bg-stone-600';
    const timeAgo = formatTimeAgo(opp.detected_at);

    return `
    <div class="card rounded-xl p-4 fade-in transition-all" style="animation-delay:${i * 0.05}s">
      <div class="flex items-start gap-3">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1.5 flex-wrap">
            <span class="text-xs font-mono text-orange-400">r/${esc(opp.subreddit)}</span>
            <span class="badge-${opp.status} text-xs px-2 py-0.5 rounded-full">${statusLabel(opp.status)}</span>
            <span class="text-xs text-stone-600">${timeAgo}</span>
            ${opp.author ? `<span class="text-xs text-stone-600">par u/${esc(opp.author)}</span>` : ''}
          </div>
          <h3 class="font-medium text-stone-100 text-sm mb-1.5 leading-snug">${esc(opp.title)}</h3>
          ${opp.body ? `<p class="text-xs text-stone-500 line-clamp-2 mb-2">${esc(opp.body.slice(0, 180))}</p>` : ''}
        </div>
        <div class="flex-shrink-0 text-center w-12">
          <div class="${scoreColor} font-bold text-base">${opp.relevance_score}/10</div>
          <div class="w-full h-1.5 bg-stone-800 rounded-full mt-1 overflow-hidden">
            <div class="${scoreBar} h-full rounded-full score-fill" style="width:${opp.relevance_score*10}%"></div>
          </div>
          <div class="text-xs text-stone-600 mt-0.5">pertinence</div>
        </div>
      </div>

      <div class="flex gap-2 mt-3 pt-3 border-t border-stone-800">
        <button onclick="openResponseModal(${opp.id}, '${esc(opp.title).replace(/'/g,"\\'")}', '${esc(opp.url)}')"
          class="flex-1 bg-honey-500 hover:bg-honey-600 text-stone-900 font-semibold text-xs py-2 px-3 rounded-lg transition-colors">
          ${opp.status === 'pending' ? 'ğŸ GÃ©nÃ©rer rÃ©ponse' : 'âœï¸ Voir rÃ©ponses'}
        </button>
        <a href="${esc(opp.url)}" target="_blank"
          class="text-stone-500 hover:text-stone-300 bg-stone-800 hover:bg-stone-700 text-xs py-2 px-3 rounded-lg transition-colors">
          Reddit â†’
        </a>
        ${opp.status !== 'approved' ? `
        <button onclick="updateOpp(${opp.id}, 'approved')"
          class="text-green-400 hover:text-green-300 bg-stone-800 hover:bg-stone-700 text-xs py-2 px-3 rounded-lg transition-colors" title="Marquer approuvÃ©e">
          âœ“
        </button>` : ''}
        <button onclick="updateOpp(${opp.id}, 'dismissed')"
          class="text-stone-600 hover:text-stone-400 bg-stone-800 hover:bg-stone-700 text-xs py-2 px-3 rounded-lg transition-colors" title="Ignorer">
          âœ•
        </button>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€ Response Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openResponseModal(oppId, title, url) {
  document.getElementById('modal-opp-title').textContent = title;
  document.getElementById('modal-loading').classList.remove('hidden');
  document.getElementById('modal-replies').innerHTML = '';
  document.getElementById('modal-replies').classList.add('hidden');

  const rdLink = document.getElementById('modal-reddit-link');
  const rdA = document.getElementById('reddit-link');
  rdA.href = url;
  rdLink.classList.remove('hidden');

  document.getElementById('modal-responses').classList.remove('hidden');

  try {
    const data = await fetch(`/api/opportunities/${oppId}/generate`, { method: 'POST' }).then(r => r.json());
    if (data.error) throw new Error(data.error);

    document.getElementById('modal-loading').classList.add('hidden');
    const repliesEl = document.getElementById('modal-replies');
    repliesEl.classList.remove('hidden');

    repliesEl.innerHTML = data.replies.map((r, i) => {
      const color = styleColors[r.style] || 'text-honey-400';
      const scoreBar = r.score >= 8 ? 'bg-green-500' : r.score >= 6 ? 'bg-honey-500' : 'bg-red-500';
      return `
      <div class="card rounded-xl p-4 fade-in" style="animation-delay:${i*0.1}s">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-semibold ${color}">${r.style}</span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-stone-500">Anti-ban</span>
            <div class="w-16 h-1.5 bg-stone-800 rounded-full overflow-hidden">
              <div class="${scoreBar} h-full rounded-full" style="width:${r.score*10}%"></div>
            </div>
            <span class="text-xs font-bold text-stone-300">${r.score}/10</span>
          </div>
        </div>
        <div class="bg-stone-900/70 rounded-lg p-3 text-stone-200 text-sm leading-relaxed whitespace-pre-wrap mb-3">${esc(r.text)}</div>
        ${r.tips && r.tips.length ? `<div class="text-xs text-stone-600 mb-3">â†’ ${r.tips.join(' Â· ')}</div>` : ''}
        <button onclick="copyReply(this, ${JSON.stringify(r.text)})"
          class="w-full bg-stone-800 hover:bg-stone-700 text-stone-300 text-xs font-medium py-2 rounded-lg transition-colors">
          ğŸ“‹ Copier
        </button>
      </div>`;
    }).join('');

    await updateOpp(oppId, 'generated', false);
    await loadOpportunities();
    await loadStats();
  } catch (err) {
    document.getElementById('modal-loading').innerHTML = `<div class="text-red-400 text-sm">Erreur : ${err.message}</div>`;
  }
}

function copyReply(btn, text) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.innerHTML;
    btn.innerHTML = 'âœ… CopiÃ© !';
    btn.style.background = '#166534';
    btn.style.color = '#4ade80';
    setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; btn.style.color = ''; }, 2500);
  });
}

// â”€â”€â”€ Create Campaign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewCampaignModal() {
  document.getElementById('modal-campaign').classList.remove('hidden');
}

async function createCampaign() {
  const brand = document.getElementById('c-brand').value.trim();
  const desc = document.getElementById('c-desc').value.trim();
  const keywords = document.getElementById('c-keywords').value.trim();
  const subs = document.getElementById('c-subs').value.trim();

  if (!brand || !desc || !keywords || !subs) { alert('Tous les champs sont requis.'); return; }

  try {
    const res = await fetch('/api/campaigns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ brand_name: brand, description: desc, keywords, subreddits: subs })
    });
    const campaign = await res.json();
    closeModal('modal-campaign');
    ['c-brand','c-desc','c-keywords','c-subs'].forEach(id => document.getElementById(id).value = '');
    await loadCampaigns();
    await loadStats();
    selectCampaign(campaign.id);
    // Reload after scan (5s delay for scan to start)
    setTimeout(async () => { await loadOpportunities(); await loadStats(); await loadCampaigns(); }, 8000);
  } catch (err) { alert('Erreur : ' + err.message); }
}

// â”€â”€â”€ Update Opportunity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateOpp(id, status, reload = true) {
  await fetch(`/api/opportunities/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  });
  if (reload) { await loadOpportunities(); await loadStats(); await loadCampaigns(); }
}

// â”€â”€â”€ Manual Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function triggerScan() {
  const btn = document.getElementById('scan-btn');
  const icon = document.getElementById('scan-icon');
  const status = document.getElementById('scan-status');
  btn.disabled = true;
  icon.className = 'spin inline-block';
  icon.textContent = 'âŸ³';
  status.textContent = 'Scan en cours...';
  status.classList.remove('hidden');
  try {
    const res = await fetch('/api/scan', { method: 'POST' }).then(r => r.json());
    status.textContent = `${res.found} nouvelles opportunitÃ©s`;
    await loadOpportunities(); await loadStats(); await loadCampaigns();
  } catch (e) {
    status.textContent = 'Erreur lors du scan';
  } finally {
    btn.disabled = false;
    icon.className = '';
    icon.textContent = 'ğŸ”';
    setTimeout(() => status.classList.add('hidden'), 4000);
  }
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

function esc(str) {
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function statusLabel(s) {
  return { pending: 'En attente', generated: 'GÃ©nÃ©rÃ©e', approved: 'ApprouvÃ©e', dismissed: 'IgnorÃ©e' }[s] || s;
}

function formatTimeAgo(dateStr) {
  const diff = (Date.now() - new Date(dateStr + 'Z').getTime()) / 1000;
  if (diff < 60) return 'Ã  l\'instant';
  if (diff < 3600) return `il y a ${Math.floor(diff/60)}min`;
  if (diff < 86400) return `il y a ${Math.floor(diff/3600)}h`;
  return `il y a ${Math.floor(diff/86400)}j`;
}

// Close modal on backdrop click
['modal-campaign','modal-responses'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal(id);
  });
});

// Auto-refresh every 2 min
setInterval(() => { loadStats(); loadCampaigns(); loadOpportunities(); }, 120000);

// Boot
init();
</script>
</body>
</html>
